<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IDKit Browser Example</title>
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #e0e0e0;
        --button-bg: #333;
        --button-text: #e0e0e0;
        --section-bg: #252525;
        --border-color: #444;
      }

      [data-theme="light"] {
        --bg-color: #ffffff;
        --text-color: #1a1a1a;
        --button-bg: #f0f0f0;
        --button-text: #1a1a1a;
        --section-bg: #f5f5f5;
        --border-color: #ddd;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        padding: 20px;
        transition:
          background-color 0.3s,
          color 0.3s;
      }

      button {
        background-color: var(--button-bg);
        color: var(--button-text);
        border: 1px solid var(--border-color);
        padding: 10px 16px;
        border-radius: 6px;
        cursor: pointer;
        margin: 4px;
      }

      button:hover {
        opacity: 0.8;
      }

      section {
        background-color: var(--section-bg);
        padding: 16px;
        border-radius: 8px;
        margin-top: 16px;
        border: 1px solid var(--border-color);
      }

      pre {
        background-color: var(--button-bg);
        padding: 12px;
        border-radius: 4px;
        overflow-x: auto;
      }

      .theme-toggle {
        position: fixed;
        top: 16px;
        right: 16px;
        background: var(--button-bg);
        border: 1px solid var(--border-color);
        color: var(--button-text);
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }

      .verify-result {
        padding: 12px;
        border-radius: 6px;
        margin: 8px 0;
      }

      .verify-result.success {
        background-color: #22c55e;
        color: white;
      }

      .verify-result.error {
        background-color: #ef4444;
        color: white;
      }

      .verify-summary {
        font-weight: bold;
        margin-bottom: 12px;
        padding: 8px;
        border-radius: 4px;
      }

      .verify-summary.all-success {
        background-color: #22c55e;
        color: white;
      }

      .verify-summary.partial-success {
        background-color: #f59e0b;
        color: white;
      }

      .verify-summary.all-failed {
        background-color: #ef4444;
        color: white;
      }

      .config-panel {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .config-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .config-row > label {
        min-width: 100px;
        opacity: 0.7;
        font-size: 14px;
      }

      .config-row input[type="text"],
      .config-row select {
        flex: 1;
        font-family: monospace;
        font-size: 14px;
        padding: 6px 10px;
        border-radius: 6px;
        border: 1px solid var(--border-color);
        background: var(--button-bg);
        color: var(--text-color);
      }

      .config-row input[type="text"][readonly] {
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <button
      class="theme-toggle"
      id="themeToggle"
      aria-label="Toggle theme"
    ></button>

    <h1>IDKit Browser Example</h1>
    <p>
      Minimal example showing World ID verification using @worldcoin/idkit-core
    </p>

    <section class="config-panel">
      <div class="config-row">
        <label for="cfgAppId">App ID</label>
        <input type="text" id="cfgAppId" readonly />
      </div>
      <div class="config-row">
        <label for="cfgRpId">RP ID</label>
        <input type="text" id="cfgRpId" readonly />
      </div>
      <div class="config-row">
        <label for="cfgAction">Action</label>
        <input type="text" id="cfgAction" value="test-action" />
      </div>
      <div class="config-row">
        <label for="cfgEnv">Environment</label>
        <select id="cfgEnv">
          <option value="production">Production</option>
          <option value="staging">Staging</option>
        </select>
      </div>
    </section>

    <div>
      <button id="verifyOrb">Verify with Orb</button>
      <button id="verifySecureDocument">Verify with Secure Document</button>
      <button id="verifyDocument">Verify with Document</button>
    </div>

    <section id="qr" hidden>
      <h3>Scan with World App</h3>
      <p id="qrUrl"></p>
      <div id="qrCode"></div>
    </section>

    <section id="status" hidden>
      <h3>Status</h3>
      <p id="statusText"></p>
    </section>

    <section id="result" hidden>
      <h3>Verification Successful</h3>
      <pre id="resultData"></pre>
    </section>

    <section id="error" hidden>
      <h3>Error</h3>
      <p id="errorText"></p>
    </section>

    <script>
      // Theme toggle functionality
      const themeToggle = document.getElementById("themeToggle");
      const html = document.documentElement;

      function updateToggleText() {
        const isDark = html.getAttribute("data-theme") !== "light";
        themeToggle.textContent = isDark ? "Light" : "Dark";
      }

      themeToggle.addEventListener("click", () => {
        const isDark = html.getAttribute("data-theme") !== "light";
        html.setAttribute("data-theme", isDark ? "light" : "dark");
        updateToggleText();
      });

      // Initialize toggle text
      updateToggleText();
    </script>

    <script type="module">
      // Import IDKit core (pure TypeScript, no dependencies)
      import {
        IDKit,
        orbLegacy,
        secureDocumentLegacy,
        documentLegacy,
      } from "@worldcoin/idkit-core";

      // Format V4 verify response with visual indicators
      function formatVerifyResult(response) {
        const results = response.results || [];
        const successCount = results.filter((r) => r.success).length;
        const total = results.length;

        // Determine summary class
        let summaryClass = "all-failed";
        if (response.success && successCount === total) {
          summaryClass = "all-success";
        } else if (successCount > 0) {
          summaryClass = "partial-success";
        }

        // Build summary HTML
        let html = `<div class="verify-summary ${summaryClass}">`;
        html += response.success
          ? `Verification Successful - ${successCount}/${total} proofs verified`
          : `Verification Failed - ${response.detail || response.code}`;
        html += "</div>";

        // Build individual result cards
        for (const result of results) {
          const cardClass = result.success ? "success" : "error";
          html += `<div class="verify-result ${cardClass}">`;
          html += `<strong>Credential: ${result.identifier}</strong>`;
          if (result.success) {
            html += `<br>Nullifier: ${result.nullifier}...`;
          } else {
            html += `<br>Error: ${result.code} - ${result.detail}`;
          }
          html += "</div>";
        }

        // Add raw JSON in collapsible details
        html += "<details><summary>Raw JSON</summary>";
        html += `<pre>${JSON.stringify(response, null, 2)}</pre>`;
        html += "</details>";

        return html;
      }

      // Demo app configuration
      // Replace with your actual app ID and RP ID from the World App dashboard
      const APP_ID = "app_982a2852d071269417befc64ab3981c2"; // Replace with your actual app ID
      const RP_ID = "rp_45a9b5d97996bb9a";

      // Populate readonly config inputs
      document.getElementById("cfgAppId").value = APP_ID;
      document.getElementById("cfgRpId").value = RP_ID;

      // Config helpers
      function getAction() {
        return (
          document.getElementById("cfgAction").value.trim() || "test-action"
        );
      }

      function getEnvironment() {
        return document.getElementById("cfgEnv").value;
      }

      // UI elements
      const qrDiv = document.getElementById("qr");
      const qrUrl = document.getElementById("qrUrl");
      const qrCode = document.getElementById("qrCode");
      const statusDiv = document.getElementById("status");
      const statusText = document.getElementById("statusText");
      const resultDiv = document.getElementById("result");
      const resultData = document.getElementById("resultData");
      const errorDiv = document.getElementById("error");
      const errorText = document.getElementById("errorText");

      const hideAll = () => {
        qrDiv.hidden = true;
        statusDiv.hidden = true;
        resultDiv.hidden = true;
        errorDiv.hidden = true;
      };

      // Fetch RP signature from the backend
      async function fetchRpSignature(action) {
        const res = await fetch("/api/rp-signature", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action }),
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || "Failed to fetch RP signature");
        }

        return res.json();
      }

      // Function to verify with World ID using the new IDKit.request().constraints() API
      async function startVerification(preset) {
        try {
          hideAll();

          statusDiv.hidden = false;
          statusText.textContent = "Fetching RP signature...";

          // Fetch RP signature from the backend
          const rpSig = await fetchRpSignature(getAction());
          console.log("RP signature response:", rpSig);
          const rpContext = {
            rp_id: RP_ID,
            nonce: rpSig.nonce,
            created_at: rpSig.created_at,
            expires_at: rpSig.expires_at,
            signature: rpSig.sig,
          };
          console.log("RP context:", rpContext);

          statusText.textContent = "Creating verification request...";

          // Create a new request using the builder pattern
          const request = await IDKit.request({
            app_id: APP_ID,
            action: getAction(),
            rp_context: rpContext,
            allow_legacy_proofs: true,
            environment: getEnvironment(),
          }).preset(preset);

          // Get the connector URL from the request
          const url = request.connectorURI;
          console.log("Connect URL:", url);

          qrDiv.hidden = false;
          qrUrl.textContent = url;

          qrCode.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(url)}" alt="QR Code">`;

          statusText.textContent = "Waiting for scan...";

          // Poll until completion
          const completion = await request.pollUntilCompletion({
            pollInterval: 2000, // Poll every 2 seconds
            timeout: 120000, // 2 minute timeout
          });

          if (!completion.success) {
            throw new Error(`Verification failed: ${completion.error}`);
          }

          const result = completion.result;
          console.log("Received proof:", result);

          // Build portal request and verify proof
          statusText.textContent = "Verifying proof...";

          const verifyResponse = await fetch("/api/verify-proof", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              rp_id: RP_ID,
              devPortalPayload: result,
            }),
          });

          const verifyResult = await verifyResponse.json();

          statusDiv.hidden = true;
          qrDiv.hidden = true;
          resultDiv.hidden = false;
          resultData.innerHTML = formatVerifyResult(verifyResult);
        } catch (error) {
          console.error("Verification error:", error);
          hideAll();
          errorDiv.hidden = false;
          errorText.textContent = `Message: ${error.message}, Code: ${error.code || "N/A"}`;
        }
      }

      // Helper to create a signal with timestamp
      const makeSignal = () => "demo-signal-" + Date.now();

      // Button event listeners
      document
        .getElementById("verifyOrb")
        .addEventListener("click", () =>
          startVerification(orbLegacy({ signal: makeSignal() })),
        );
      document
        .getElementById("verifySecureDocument")
        .addEventListener("click", () =>
          startVerification(secureDocumentLegacy({ signal: makeSignal() })),
        );
      document
        .getElementById("verifyDocument")
        .addEventListener("click", () =>
          startVerification(documentLegacy({ signal: makeSignal() })),
        );
    </script>
  </body>
</html>
