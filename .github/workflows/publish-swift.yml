name: Publish Swift Release

on:
  pull_request:
    types: [closed]
    branches:
      - main

permissions:
  contents: write

jobs:
  publish-swift:
    if: github.event.pull_request.merged == true && contains(github.event.pull_request.labels.*.name, 'release')
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2

      - name: Build Swift artifacts
        run: scripts/package-swift.sh

      - name: Zip XCFramework
        run: zip -r IDKitFFI.xcframework.zip IDKitFFI.xcframework

      - name: Compute checksum
        id: checksum
        run: |
          CHECKSUM=$(swift package compute-checksum IDKitFFI.xcframework.zip)
          echo "checksum=$CHECKSUM" >> "$GITHUB_OUTPUT"

      - name: Determine release version
        id: version
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name=="idkit-uniffi") | .version')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Create draft release in idkit-swift
        id: release
        uses: softprops/action-gh-release@v2
        with:
          repository: worldcoin/idkit-swift
          name: ${{ steps.version.outputs.version }}
          tag_name: ${{ steps.version.outputs.version }}
          make_latest: false
          draft: true
          fail_on_unmatched_files: true
          files: IDKitFFI.xcframework.zip
          token: ${{ secrets.GIT_HUB_TOKEN }}
          body: |
            Please review https://github.com/worldcoin/idkit/releases/tag/${{ steps.version.outputs.version }} for release notes.

      - name: Checkout idkit-swift repository
        uses: actions/checkout@v4
        with:
          repository: worldcoin/idkit-swift
          token: ${{ secrets.GIT_HUB_TOKEN }}
          path: idkit-swift

      - name: Sync generated Swift sources
        run: |
          rm -rf idkit-swift/Sources
          mkdir -p idkit-swift/Sources
          cp -R swift/Sources/IDKit idkit-swift/Sources/
          rm -f idkit-swift/Package.resolved

      - name: Update Package.swift metadata
        run: |
          ASSET_URL="${{ fromJSON(steps.release.outputs.assets)[0].url }}.zip"
          VERSION=${{ steps.version.outputs.version }}
          CHECKSUM=${{ steps.checksum.outputs.checksum }}

          python3 <<'EOF'
          import pathlib
          import re
          import os

          asset_url = os.environ['ASSET_URL']
          version = os.environ['VERSION']
          checksum = os.environ['CHECKSUM']

          package = pathlib.Path('idkit-swift/Package.swift')
          text = package.read_text()
          text = re.sub(r'url: "[^"]+"', f'url: "{asset_url}"', text)
          text = re.sub(r'checksum: "[^"]+"', f'checksum: "{checksum}"', text)
          text = re.sub(r'// Release version: .*', f'// Release version: {version}', text)
          package.write_text(text)
          EOF

      - name: Commit and tag release
        working-directory: idkit-swift
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Package.swift Sources
          git commit -m "Release ${VERSION}"
          git tag "${VERSION}"
          git push
          git push origin "${VERSION}"

      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GIT_HUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          gh release edit "$VERSION" \
            --repo worldcoin/idkit-swift \
            --draft=false \
            --latest
