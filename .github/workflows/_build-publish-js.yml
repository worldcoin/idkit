# Reusable workflow for building and publishing JS/WASM package
# Called by publish-js.yml (stable) and release-dev-js.yml (dev)

name: Build and Publish JS

on:
  workflow_call:
    inputs:
      version:
        description: "Version to publish (e.g., 4.0.1 or 4.0.1-dev.abc1234)"
        required: true
        type: string
      npm_tag:
        description: "npm tag (latest or dev)"
        required: true
        type: string
      environment:
        description: "GitHub environment (production or development)"
        required: true
        type: string
      ref:
        description: "Git ref to checkout (commit SHA, branch, or tag)"
        required: false
        type: string
        default: ""

jobs:
  build-and-publish:
    runs-on:
      group: arc-public-large-amd64-runner
    environment: ${{ inputs.environment }}
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.ref || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: https://registry.npmjs.org

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Update npm for OIDC trusted publishing
        run: |
          # npm trusted publishing requires npm >= 11.5.1
          echo "Current npm version: $(npm --version)"
          npm install -g npm@latest
          echo "Updated npm version: $(npm --version)"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        run: cargo install wasm-pack --locked

      # Use env vars to avoid shell injection from workflow inputs
      - name: Set package version
        working-directory: js/packages/core
        env:
          PKG_VERSION: ${{ inputs.version }}
        run: |
          npm version "$PKG_VERSION" --no-git-tag-version --allow-same-version
          echo "ðŸ“¦ Package version set to: $PKG_VERSION"

      - name: Install dependencies
        working-directory: js
        run: pnpm install

      - name: Build packages
        working-directory: js
        run: pnpm -r build

      - name: Publish @worldcoin/idkit-core
        working-directory: js
        env:
          PKG_VERSION: ${{ inputs.version }}
          NPM_TAG: ${{ inputs.npm_tag }}
        run: |
          echo "ðŸš€ Publishing @worldcoin/idkit-core@$PKG_VERSION with tag '$NPM_TAG'"
          pnpm --filter @worldcoin/idkit-core publish --access public --no-git-checks --provenance --tag "$NPM_TAG"
